YUI.add("moodle-tinymce_mathslate-mathjaxeditor",function(e,t){M.tinymce_mathslate=M.tinymce_mathslate||{},NS=M&&M.tinymce_mathslate||{};var n=!0,r={SELECTED:"mathslate-selected",WORKSPACE:"mathslate-workspace",PREVIEW:"mathslate-preview",HIGHLIGHT:"mathslate-highlight",DRAGNODE:"mathslate-workspace-drag",DRAGGEDNODE:"mathslate-workspace-dragged",HELPBOX:"mathslate-help-box",PANEL:"mathslate-bottom-panel"},i={SELECTED:"."+r.SELECTED,HIGHLIGHT:"."+r.HIGHLIGHT};NS.MathJaxEditor=function(t){function m(){u=e.Node.create('<span style="opacity: 0"></span>'),u.setHTML(o.preview().replace(/div/g,"span").replace(/<\/*br>/g,"")),e.one(t).appendChild(u),u.all("span").each(function(t){if(!c.get("node").one("#"+t.getAttribute("id")))return;t.appendChild('<span style="position: relative; z-index: -1"><math display="inline">'+y([e.JSON.parse(o.getItemByID(t.getAttribute("id")))]).replace(/id="[^"]*"/,"")+"</math></span>"),t.setAttribute("style","position: absolute; top: 0; left: 0; margin: 0px")}),u.all("span").each(function(e){if(!c.get("node").one("#"+e.getAttribute("id")))return;var t=c.get("node").one("#"+e.getAttribute("id")).getDOMNode().getBoundingClientRect(),n=e.getDOMNode().getBoundingClientRect();e.setStyle("top",t.top-n.top),e.setStyle("left",t.left-n.left),e.setStyle("width",t.width),e.setStyle("height",t.height)}),MathJax.Hub.Queue(["Typeset",MathJax.Hub,u.getDOMNode()])}function g(){u&&u.remove(),c.get("node").one(".math")||!n?a=c.get("node"):(m(),a=u),l.setHTML('<div class="'+r.PREVIEW+'">'+o.preview("tex")+"</div>"),o.getSelected()&&l.one("#"+o.getSelected())&&(c.get("node").one("#"+o.getSelected()).addClass(r.SELECTED),c.get("node").one("#"+o.getSelected()).setAttribute("mathcolor","green"),c.get("node").one("#"+o.getSelected()).setAttribute("stroke","green"),c.get("node").one("#"+o.getSelected()).setAttribute("fill","green"),l.one("#"+o.getSelected()).addClass(r.SELECTED)),o.forEach(function(t){var s=a.one("#"+t[1].id);if(!s)return;s.setAttribute("title",l.one("#"+t[1].id).getHTML().replace(/<div *[^>]*>|<\/div>|<br>/g,"")),s.handleClick=function(e){var t=a.one("#"+o.getSelected());if(!t){e.stopPropagation(),o.select(this.getAttribute("id")),b();return}if(t===s){if(l.one("#"+s.getAttribute("id")).test("."+r.PREVIEW+" >")){o.select(),b();return}s.removeClass(r.SELECTED),l.one("#"+s.getAttribute("id")).removeClass(r.SELECTED),c.get("node").one("#"+o.getSelected()).removeAttribute("mathcolor"),c.get("node").one("#"+o.getSelected()).removeAttribute("stroke"),c.get("node").one("#"+o.getSelected()).removeAttribute("fill"),o.select();return}if(t.one("#"+this.getAttribute("id")))return;e.stopPropagation(),o.insertSnippet(s.getAttribute("id"),o.removeSnippet(t.getAttribute("id"))),o.select(),b()},s.on("click",function(e){this.handleClick(e)});var f=a.one("#"+o.getSelected());if(!n)return;if((!t[1]||!t[1]["class"]||t[1]["class"]!=="blank")&&(!f||!l.one("#"+o.getSelected()).one("#"+t[1].id))){var h=(new e.DD.Drag({node:s})).plug(e.Plugin.DDProxy,{resizeFrame:!1,moveOnEnd:!1});h.on("drag:start",function(){c.get("node").one("#"+o.getSelected())&&(l.one("#"+o.getSelected()).removeClass(r.SELECTED),c.get("node").one("#"+o.getSelected()).removeClass(r.SELECTED),c.get("node").one("#"+o.getSelected()).removeAttribute("mathcolor"),c.get("node").one("#"+o.getSelected()).removeAttribute("stroke"),c.get("node").one("#"+o.getSelected()).removeAttribute("fill"),o.select()),this.get("node").addClass(r.DRAGGEDNODE),this.get("node").setAttribute("mathcolor","red"),a===u?this.get("dragNode").set("innerHTML",this.get("node").get("children").pop().getHTML()):this.get("dragNode").set("innerHTML",this.get("node").getHTML()),a.one("#"+t[1].id).setAttribute("mathcolor","red"),a.one("#"+t[1].id).setAttribute("stroke","red"),this.get("dragNode").addClass(r.DRAGNODE)}),h.on("drag:end",function(){this.get("node").removeClass(r.DRAGGEDNODE),this.get("node").removeAttribute("mathcolor"),this.get("node").removeAttribute("stroke")})}var p=new e.DD.Drop({node:s});p.on("drop:hit",function(e){var n=e.drag.get("node").get("id");e.drag.get("data")?o.insertSnippet(t[1].id,o.createItem(e.drag.get("data"))):n!==t[1].id&&o.isItem(n)&&!l.one("#"+n).one("#"+t[1].id)&&o.insertSnippet(e.drop.get("node").get("id"),o.removeSnippet(n)),b()}),p.on("drop:enter",function(e){e.stopPropagation(),a.all(i.HIGHLIGHT).each(function(e){e.removeClass(r.HIGHLIGHT);var t=e.getAttribute("id");c.get("node").one("#"+t)&&(c.get("node").one("#"+t).removeClass(r.HIGHLIGHT),c.get("node").one("#"+t).removeAttribute("mathcolor"),c.get("node").one("#"+t).removeAttribute("stroke"),c.get("node").one("#"+t).removeAttribute("fill"))}),a.one("#"+t[1].id).addClass(r.HIGHLIGHT),c.get("node").one("#"+t[1].id).addClass(r.HIGHLIGHT),c.get("node").one("#"+t[1].id).setAttribute("mathcolor","yellow"),c.get("node").one("#"+t[1].id).setAttribute("stroke","yellow"),c.get("node").one("#"+t[1].id).setAttribute("fill","yellow")}),p.on("drop:exit",function(e){e.stopPropagation(),this.get("node").removeClass(r.HIGHLIGHT),c.get("node").one("#"+t[1].id).removeClass(r.HIGHLIGHT),c.get("node").one("#"+t[1].id).removeAttribute("mathcolor"),c.get("node").one("#"+t[1].id).removeAttribute("stroke"),c.get("node").one("#"+t[1].id).removeAttribute("fill")})})}function y(e){if(typeof e!="object")return e;var t="";return e.forEach(function(e){var n;if(typeof e!="object")return;t+="<"+e[0];if(e[1]&&typeof e[1]=="object")for(n in e[1])typeof e[1][n]!="object"&&(t+=" "+n+'="'+e[1][n]+'"');t+=">",e[2]&&(t+=y(e[2])),t+="</"+e[0]+">"}),t}function b(){o.rekey();var e=MathJax.Hub.getAllJax("canvas")[0];e?MathJax.Hub.Queue(function(){MathJax.Hub.Queue(["Text",e,"<math>"+y(s)+"</math>"]),MathJax.Hub.Queue(g)}):(c.get("node").setHTML(""),MathJax.Hub.Queue(["addElement",MathJax.HTML,c.get("node").getDOMNode(),"math",{display:"block"},s]),MathJax.Hub.Queue(["Typeset",MathJax.Hub,"canvas"]),MathJax.Hub.Queue(g))}var s=[],o=new NS.mSlots;o.slots.push(s);var u,a;this.workspace=e.one(t).append('<div id="canvas" class="'+
r.WORKSPACE+'"/>');var f=e.one(t).appendChild(e.Node.create("<form></form>")),l=e.one(t).appendChild(e.Node.create('<div class="'+r.PANEL+'"/>'));l.delegate("click",function(e){a.one("#"+this.getAttribute("id")).handleClick(e)},"div");var c=new e.DD.Drop({node:this.workspace.one("#canvas")});this.canvas=c,this.canvas.get("node").on("click",function(){o.select(),b()});var h=e.Node.create('<button type="button" class="'+r.UNDO+'"'+'" title="'+M.util.get_string("undo","tinymce_mathslate")+'"/>'+"<math><mo>&#x25C1;</mo></math>"+"</button>"),p=e.Node.create('<button type="button" class="'+r.REDO+'"'+'" title="'+M.util.get_string("redo","tinymce_mathslate")+'"/>'+"<math><mo>&#x25B7;</mo></math>"+"</button>"),d=e.Node.create('<button type="button" class="'+r.CLEAR+'"'+'" title="'+M.util.get_string("clear","tinymce_mathslate")+'"/>'+"<math><mi>&#x2718;</mi></math>"+"</button>"),v=e.Node.create('<button type="button" class="'+r.HELP+'" title="'+M.util.get_string("help","tinymce_mathslate")+'">'+"<math><mi>&#xE47C;</mi></math>"+"</button>");f.appendChild(d),f.appendChild(h),f.appendChild(p),f.appendChild(v),p.on("click",function(){o=o.redo(),s=o.slots[0],b()}),h.on("click",function(){o=o.undo(),s=o.slots[0],b()}),d.on("click",function(){e.one(i.SELECTED)?o.removeSnippet(e.one(i.SELECTED).getAttribute("id")):(s=[],o.next=new NS.mSlots,o.next.previous=o,o=o.next,o.slots.push(s)),b()}),v.on("click",function(){l.setHTML('<iframe src="'+NS.help+'" style="width: '+l.getStyle("width")+'" class="'+r.HELPBOX+'"/>')}),this.render=b,this.toMathML=y,this.addMath=function(t){if(!t)return;e.one(i.SELECTED)?o.insertSnippet(e.one(i.SELECTED).getAttribute("id"),o.createItem(t)):o.append(o.createItem(t)),b()},this.clear=function(){e.one(i.SELECTED)?o.removeSnippet(e.one(i.SELECTED).getAttribute("id")):(s=[],o.next=new NS.mSlots,o.next.previous=o,o=o.next,o.slots.push(s)),b()},this.output=function(t){function n(e){if(typeof e!="object")return e;var t=e.slice(0);return t.forEach(function(e,r){if(typeof e!="object")return;if(e[1]&&e[1]["class"]){t[r]="[]";return}e[1]&&e[1].id&&delete e[1].id,e[2]&&(e[2]=n(e[2]))}),t}return t==="MathML"?c.get("node").one("script").getHTML():t==="HTML"?c.get("node").one("span").getHTML():t==="JSON"?e.JSON.stringify(n(s)):o.output(t)},this.getHTML=function(){return c.get("node").one("span").getHTML()},this.redo=function(){o=o.redo(),s=o.slots[0],b()},this.undo=function(){o=o.undo(),s=o.slots[0],b()},this.makeDrops=function(){m()},b()}},"@VERSION@",{requires:["moodle-tinymce_mathslate-snippeteditor","dd-proxy","dd-drop"]});
