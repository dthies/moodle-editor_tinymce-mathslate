YUI.add("moodle-tinymce_mathslate-mathjaxeditor",function(f,e){var v,E,S,A,H;M.tinymce_mathslate=M.tinymce_mathslate||{},v=M&&M.tinymce_mathslate||{},E=!0,A="."+(S={SELECTED:"mathslate-selected",WORKSPACE:"mathslate-workspace",PREVIEW:"mathslate-preview",HIGHLIGHT:"mathslate-highlight",DRAGNODE:"mathslate-workspace-drag",DRAGGEDNODE:"mathslate-workspace-dragged",HELPBOX:"mathslate-help-box",PANEL:"mathslate-bottom-panel"}).SELECTED,H="."+S.HIGHLIGHT,v.MathJaxEditor=function(d){var e,a,t,s,r,o,n,i,l,c=window.MathJax,g=[],u=new v.mSlots;function p(){(e=f.Node.create("<span></span>")).setHTML(u.preview().replace(/div/g,"span").replace(/<\/*br>/g,"")),f.one(d).appendChild(e),e.all("span").each(function(e){r.get("node").one("#"+e.getAttribute("id"))&&(e.appendChild('<span style="position: relative; opacity: 0"><math display="inline">'+m([f.JSON.parse(u.getItemByID(e.getAttribute("id")))]).replace(/id="[^"]*"/,"")+"</math></span>"),e.setAttribute("style","position: absolute; top: 0; left: 0; margin: 0px; z-index: +1"))}),e.all("span").each(function(e){var t,o;r.get("node").one("#"+e.getAttribute("id"))&&(t=r.get("node").one("#"+e.getAttribute("id")).getDOMNode().getBoundingClientRect(),o=e.getDOMNode().getBoundingClientRect(),e.setStyle("top",t.top-o.top),e.setStyle("left",t.left-o.left),e.setStyle("width",t.width),e.setStyle("height",t.height))}),c.Hub.Queue(["Typeset",c.Hub,e.getDOMNode()])}function h(){e&&e.remove(),p(),a=e,s.setHTML('<div class="'+S.PREVIEW+'">'+u.preview("tex")+"</div>"),u.getSelected()&&s.one("#"+u.getSelected())&&(r.get("node").one("#"+u.getSelected()).addClass(S.SELECTED),r.get("node").one("#"+u.getSelected()).setAttribute("mathcolor","green"),r.get("node").one("#"+u.getSelected()).setAttribute("stroke","green"),r.get("node").one("#"+u.getSelected()).setAttribute("fill","green"),s.one("#"+u.getSelected()).addClass(S.SELECTED)),u.forEach(function(o){var e,t,n,i=a.one("#"+o[1].id);i&&(i.setAttribute("title",s.one("#"+o[1].id).getHTML().replace(/<div *[^>]*>|<\/div>|<br>/g,"")),i.handleClick=function(e){var t=a.one("#"+u.getSelected());return t?t===i?s.one("#"+i.getAttribute("id")).test("."+S.PREVIEW+" >")?(u.select(),void b()):(i.removeClass(S.SELECTED),s.one("#"+i.getAttribute("id")).removeClass(S.SELECTED),r.get("node").one("#"+u.getSelected()).removeAttribute("mathcolor"),r.get("node").one("#"+u.getSelected()).removeAttribute("stroke"),r.get("node").one("#"+u.getSelected()).removeAttribute("fill"),void u.select()):void(t.one("#"+this.getAttribute("id"))||(e.stopPropagation(),u.insertSnippet(i.getAttribute("id"),u.removeSnippet(t.getAttribute("id"))),u.select(),b())):(e.stopPropagation(),u.select(this.getAttribute("id")),void b())},i.on("click",function(e){this.handleClick(e)}),e=a.one("#"+u.getSelected()),E&&(o[1]&&o[1]["class"]&&"blank"===o[1]["class"]||e&&s.one("#"+u.getSelected()).one("#"+o[1].id)||((t=new f.DD.Drag({node:i,moveOnEnd:!1})).on("drag:start",function(){r.get("node").one("#"+u.getSelected())&&(s.one("#"+u.getSelected()).removeClass(S.SELECTED),r.get("node").one("#"+u.getSelected()).removeClass(S.SELECTED),r.get("node").one("#"+u.getSelected()).removeAttribute("mathcolor"),r.get("node").one("#"+u.getSelected()).removeAttribute("stroke"),r.get("node").one("#"+u.getSelected()).removeAttribute("fill"),u.select()),this.get("node").addClass(S.DRAGGEDNODE),this.get("node").setAttribute("mathcolor","red"),a.one("#"+o[1].id).setAttribute("mathcolor","red"),a.one("#"+o[1].id).setAttribute("stroke","red"),this.get("dragNode").addClass(S.DRAGNODE),this.get("dragNode").all("> span").pop().setStyle("opacity","1")}),t.on("drag:end",function(){this.get("node").removeClass(S.DRAGGEDNODE),this.get("node").removeAttribute("mathcolor"),this.get("node").removeAttribute("stroke"),this.get("dragNode").all("> span").pop().setStyle("opacity","0"),this.get("dragNode").setStyles({top:0,left:0})})),(n=new f.DD.Drop({node:i})).on("drop:hit",function(e){var t=e.drag.get("node").get("id");e.drag.get("data")?u.insertSnippet(o[1].id,u.createItem(e.drag.get("data"))):t!==o[1].id&&u.isItem(t)&&!s.one("#"+t).one("#"+o[1].id)&&u.insertSnippet(e.drop.get("node").get("id"),u.removeSnippet(t)),b()}),n.on("drop:enter",function(e){e.stopPropagation(),a.all(d+" "+H).each(function(e){e.removeClass(S.HIGHLIGHT);var t=e.getAttribute("id");r.get("node").one(t)&&(r.get("node").one(t).removeClass(S.HIGHLIGHT),r.get("node").one(t).removeAttribute("mathcolor"),r.get("node").one(t).removeAttribute("stroke"),r.get("node").one(t).removeAttribute("fill"))}),a.one("#"+o[1].id).addClass(S.HIGHLIGHT),r.get("node").one("#"+o[1].id).addClass(S.HIGHLIGHT),r.get("node").one("#"+o[1].id).setAttribute("mathcolor","yellow"),r.get("node").one("#"+o[1].id).setAttribute("stroke","yellow"),r.get("node").one("#"+o[1].id).setAttribute("fill","yellow")}),n.on("drop:exit",function(e){e.stopPropagation(),this.get("node").removeClass(S.HIGHLIGHT),r.get("node").one("#"+o[1].id).removeClass(S.HIGHLIGHT),r.get("node").one("#"+o[1].id).removeAttribute("mathcolor"),r.get("node").one("#"+o[1].id).removeAttribute("stroke"),r.get("node").one("#"+o[1].id).removeAttribute("fill")})))})}function m(e){if("object"!=typeof e)return e;var o="";return e.forEach(function(e){var t;if("object"==typeof e){if(o+="<"+e[0],e[1]&&"object"==typeof e[1])for(t in e[1])"object"!=typeof e[1][t]&&(o+=" "+t+'="'+e[1][t]+'"');o+=">",e[2]&&(o+=m(e[2])),o+="</"+e[0]+">"}}),o}function b(){u.rekey();var e=c.Hub.getAllJax(r.get("node").getDOMNode())[0];e?c.Hub.Queue(function(){c.Hub.Queue(["Text",e,"<math>"+m(g)+"</math>"]),c.Hub.Queue(h)}):(r.get("node").setHTML(""),c.Hub.Queue(["addElement",c.HTML,r.get("node").getDOMNode(),"math",{display:"block"},g]),c.Hub.Queue(["Typeset",c.Hub,r.get("node").getDOMNode()]),c.Hub.Queue(h))}u.slots.push(g),this.workspace=f.one(d).append('<div id="canvas" class="'+S.WORKSPACE+'"/>'),t=f.one(d).appendChild(f.Node.create("<form></form>")),(s=f.one(d).appendChild(f.Node.create('<div class="'+S.PANEL+'"/>'))).delegate("click",
function(e){a.one("#"+this.getAttribute("id")).handleClick(e)},"div"),r=new f.DD.Drop({node:this.workspace.one("#canvas")}),this.canvas=r,this.canvas.get("node").on("click",function(){u.select(),b()}),o=f.Node.create('<button type="button" class="'+S.UNDO+'"" title="'+M.util.get_string("undo","tinymce_mathslate")+'"/><math><mo>&#x25C1;</mo></math></button>'),n=f.Node.create('<button type="button" class="'+S.REDO+'"" title="'+M.util.get_string("redo","tinymce_mathslate")+'"/><math><mo>&#x25B7;</mo></math></button>'),i=f.Node.create('<button type="button" class="'+S.CLEAR+'"" title="'+M.util.get_string("clear","tinymce_mathslate")+'"/><math><mi>&#x2718;</mi></math></button>'),l=f.Node.create('<button type="button" class="'+S.HELP+'" title="'+M.util.get_string("help","tinymce_mathslate")+'"><math><mi>&#xE47C;</mi></math></button>'),t.appendChild(i),t.appendChild(o),t.appendChild(n),t.appendChild(l),n.on("click",function(){u=u.redo(),g=u.slots[0],b()}),o.on("click",function(){u=u.undo(),g=u.slots[0],b()}),i.on("click",function(){f.one(d+" "+A)?u.removeSnippet(f.one(d+" "+A).getAttribute("id")):(g=[],u.next=new v.mSlots,(u=(u.next.previous=u).next).slots.push(g)),b()}),l.on("click",function(){s.setHTML('<iframe src="'+v.help+'" style="width: '+s.getStyle("width")+'" class="'+S.HELPBOX+'"/>')}),this.render=b,this.toMathML=m,this.addMath=function(e){e&&(f.one(d+" "+A)?u.insertSnippet(f.one(d+" "+A).getAttribute("id"),u.createItem(e)):u.append(u.createItem(e)),b())},this.clear=function(){f.one(d+" "+A)?u.removeSnippet(f.one(d+" "+A).getAttribute("id")):(g=[],u.next=new v.mSlots,(u=(u.next.previous=u).next).slots.push(g)),b()},this.output=function(e){return"MathML"===e?r.get("node").one("script").getHTML():"HTML"===e?r.get("node").one("span").getHTML():"JSON"===e?f.JSON.stringify(function n(e){if("object"!=typeof e)return e;var o=e.slice(0);return o.forEach(function(e,t){"object"==typeof e&&(e[1]&&e[1]["class"]?o[t]="[]":(e[1]&&e[1].id&&delete e[1].id,e[2]&&(e[2]=n(e[2]))))}),o}(g)):u.output(e)},this.getHTML=function(){return r.get("node").one("span").getHTML()},this.redo=function(){u=u.redo(),g=u.slots[0],b()},this.undo=function(){u=u.undo(),g=u.slots[0],b()},this.makeDrops=function(){p()},b()}},"@VERSION@",{requires:["moodle-tinymce_mathslate-snippeteditor","dd-drop"]});